#!/bin/sh
# 简化版 chroot-distro for OpenWrt
# 只实现最基础功能

CHROOT_BASE="/opt/chroot-distro"

print_msg() {
  printf "%s\n" "$1"
}

show_help() {
  cat <<EOF
Usage: $0 <command> [options]

Commands:
  help                     Show this message
  list                     List available distros
  install <distro>         Install distro (simple tarball extract)
  remove <distro>          Remove installed distro
  login <distro>     Enter chroot for distro
EOF
}

list_distros() {
  [ -d "$CHROOT_BASE" ] || mkdir -p "$CHROOT_BASE"
  print_msg "Installed distributions:"
  ls "$CHROOT_BASE"
}

install_distro() {
  distro="$1"
  url="$2"
  if [ -z "$distro" ]; then
    print_msg "No distro specified"
    return 1
  fi

  print_msg "Installing $distro..."
  mkdir -p "$CHROOT_BASE/$distro"
  # 如果需要自动下载，用户传 URL
  if [ -n "$url" ]; then
    print_msg "Downloading from $url"
    wget -O "/tmp/${distro}.tar.xz" "$url"
    tar -C "$CHROOT_BASE/$distro" -xf "/tmp/${distro}.tar.xz"
    rm -f "/tmp/${distro}.tar.xz"
  fi
  print_msg "$distro installed at $CHROOT_BASE/$distro"
}

remove_distro() {
  distro="$1"
  if [ -z "$distro" ]; then
    print_msg "No distro specified"
    return 1
  fi
  rm -rf "$CHROOT_BASE/$distro"
  print_msg "$distro removed"
}

login_chroot() {
  distro="$1"
  shift
  if [ -z "$distro" ]; then
    print_msg "No distro specified"
    return 1
  fi
  if [ ! -d "$CHROOT_BASE/$distro" ]; then
    print_msg "$distro not found"
    return 1
  fi

  # 简单挂载 proc/sys/dev
  if grep -qs " $CHROOT_BASE/$distro/dev " /proc/self/mounts; then
        echo "[INFO] /dev already mounted."
  else
        echo "[INFO] Mounting /dev ..."
        mount -t proc proc "$CHROOT_BASE/$distro/proc"
        mount --rbind /sys "$CHROOT_BASE/$distro/sys"
        mount --rbind /dev "$CHROOT_BASE/$distro/dev"
  fi
  # 进入 chroot
  chroot "$CHROOT_BASE/$distro" su - root
}

cmd="$1"
shift

case "$cmd" in
  help|"")
    show_help
    ;;
  list)
    list_distros
    ;;
  install)
    install_distro "$@"
    ;;
  remove)
    remove_distro "$@"
    ;;
  login)
    login_chroot "$@"
    ;;
  *)
    print_msg "Unknown command: $cmd"
    show_help
    exit 1
    ;;
esac
